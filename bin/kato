#!/usr/bin/env node

var async = require('async'),
    optimist = require('optimist').demand(1).usage('Usage: $0 file_or_directory...'),
    winston = require('winston').cli(),
    cliff = require('cliff'),
    atomify = require('../lib/atomify.js'),
    cleanup = require('../lib/cleanup.js'),
    kutil = require('../lib/kutil.js'),
    queue = require('../lib/queue.js');

var argv = optimist.boolean(['a','cleanup','overwrite']).options({
  a: {
    description: 'Atomify mode. Pass in existing mp4 files to have\n               their metadata refreshed and persisted.'
  },
  cleanup: {
    description: 'Cleanup mode. Remove source files and move outfiles to iTunes.'
  },
  overwrite: {
    description: 'Process files even if an existing outfile already\n               exists. Overwrite existing outfile.'
  }
  //,
  //n: {
  //  description: 'Don\'t actually do anything. This is just a test run.'
  //}
}).argv;

if (argv.h || argv.help) {
  console.log([
    'kato: Swiss army knife for converting video files to iTunes-friendly format',
    ''
  ].join('\n'));
  console.log(optimist.help());
  return;
}


if (argv.cleanup) {
  cleanup.run(argv._);
} else {
  for (var i in argv._) {
    if (argv.a) {
      queue.atomify(argv._[i]);
    } else {
      queue.transcode(argv._[i]);
    }
  }
}
